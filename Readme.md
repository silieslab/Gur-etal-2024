# Gur et al. 2024 codebase

Here you can find the code for analyzing the datasets of Gur et al. 2024. All datasets are deposited to Zenodo: https://zenodo.org/doi/10.5281/zenodo.13327244.

## Nat scenes and normalization model
The code for analysis and simulations done for the natural scene analysis in Figure 3 and the biophysical implementation of the normalization model in Figure 5.

Refer to the Readme.txt located in the folder “Nat scenes and normalization model”.

## Two photon imaging analysis
Code located in 2pAnalysis folder. All code is written in Python 2.7 (folder “python2p7”) except Dm12 imaging analysis which is MATLAB based (folder “Dm12”).

### Motion alignment of raw time series and ROI selection with stimulus specific pre processing
#### Step 1: motion alignment and folder organisation
run_pre_processing_CPP.py
	Alignment and folder processing of data acquired with C++ stimulation package
run_pre_processing_PyStim.py
	Alignment and folder processing of data acquired with PyStim stimulation package

#### Step 2: ROI selection and stimulus specific pre processing for single time series 
run_analysis_CPP.py
	ROI selection and preprocessing according to the stimulus (generated via C++ stimulation package) used 
run_analysis_PyStim.py
	ROI selection and preprocessing according to the stimulus (generated via PyStim stimulation package) used 
run_analysisWN_CPP.py
	ROI selection and preprocessing of white noise stimulus generated by C++ stimulation package
run_analysisWN_PyStim.py
	ROI selection and preprocessing of white noise stimulus generated by PyStim stimulation package
run_online_RF_mapping.py
	ROI selection and preprocessing of white noise stimulus generated by PyStim stimulation package 		and additionally generating centered stimuli for a suitable ROI


### Processing data and saving the processed data:
For some figures, code in this section already makes the final plots after processing.

#### 1 Hz drifting sinusoidal gratings with 100% contrast
code: GUR_etAl_2024_post_analysis_1HzLuminanceGratings_cPP_saveData.py
	- 1Hz gratings L2-L3 (Figure 1) - Tm1,2,4,9 (Figure 2)
		raw data: L2-L3-TmX-edges-1Hzsine-11steps
	- 1 Hz gratings Tm9 iGluSnFR (Figure 5)
		raw data: Tm9iGluSnFR

GUR_etAl_2024_post_analysis_1HzLuminanceGratings_PyStim_saveData.py
	- 1Hz gratings Tm9 and Tm1 GluClalpha flpSTOP experiments (Figure 6, Figure S5)
		raw data: Tm9GluClalphaFLPSTOP, Tm1GluClalphaFLPSTOP
	- 1Hz gratings Tm1 iGluSnFR (Figure 5)
		raw data: Tm1iGluSnFR

GUR_etAl_2024_post_analysis1HzLuminanceGratings_T4T5_cPP_saveData.py
	- 1Hz gratings T4T5 (Figure 1)
		raw data: T4_T5_luminanceGain>luminance_gratings

#### Moving OFF edges with 100% contrast and 6 different backgrounds
GUR_etAl_2024_post_analysis_edges_T4T5_cpp_saveData.py
	- Analysis of T5 neurons (Figure 1)
		raw data: T4_T5_luminanceGain>luminane_edges
GUR_etAl_2024_post_analysis_edges_cpp_saveData.py
	- Analysis of L2 and L3 neurons (Figure 1)
		raw data: L2-L3-TmX-edges-1Hzsine-11steps

#### 1Hz drifting gratings with 5 contrast and 5 luminance levels

GUR_etAl_2024_post_analysis_LumConGratings_cpp.py (Figure 2, Figure S1)
	- Analysis and plotting of responses of L1, L2, L3, Tm1, Tm9 neurons (directly produces final plots but without stats)
	- Saving processed data for stats 
		raw data: L2_L3_Tm1_Tm9_luminanceContrast (also has L1)


GUR_etAl_2024_post_analysis_ANOVA_contLum.py
	- statistical testing of responses
 
#### Periodic full field 5 second ON and OFF flashes 

GUR_etAl_2024_post_analysis_FFF_PyStim.py
	- Analysis and plotting of Tm1 iGluSnFR recordings (Figure S4) (for final plots)
		raw data: Tm1iGluSnFR

GUR_etAl_2024_post_analysis_FFF_cpp.py
	- Analysis and plotting of Tm9 iGluSnFR recordings (Figure S4) (for final plots)
		raw data: Tm9iGluSnFR

#### Centered drifting gratings with various sizes for online RF mapping and stimulation
GUR_etAl_2024_post_analysis_centerGrating_Gur_etAl_PyStim.py
	- Analysis and plotting of Tm1 and Tm9 single neuron stimulation (Figure 4) (for final plots)
		raw data: SpatialPooling_Tm1_Tm9/changingGratingSize

#### Centered drifting grating with constant contrast and luminance, with background annulus for online RF mapping and stimulation
GUR_etAl_2024_post_analysis_annulusCentGrat_PyStim.py
	- Analysis and plotting of Tm1 and Tm9 single neuron stimulation (Figure 4, Figure S3) (for final plots)
		raw data: SpatialPooling_Tm1_Tm9/annulusStim

### Analyzing processed data 

#### 1 Hz gratings with 100% contrast
GUR_etAl_2024_post_analysis_processAll1Hz.py (Figure 1, 2, 5, 6 S5)
	- does stats of processed data for Figure 1, 2, 5, 6 S5
	- processed data are located under “processed_data/2p_imaging_python_pickle”


#### Moving dark edges with 100% contrast and 6 different backgrounds
GUR_etAl_2024_post_analysis_processL2L3T45_edges.py (Figure 1)
	- does plots and stats of processed data for Figure 1 
	- processed data are located under “processed_data/2p_imaging_python_pickle”

#### Analysis of spatiotemporal receptive fields after white noise stimulation
GUR_etAl_2024_post_analysis_STRF.py
	- does analysis and plots of STRFs and FWHM measurements for Figure S4
	- data is located: 
		raw_data>L2-L3-TmX-edges-1Hzsine-11steps (for STRFs of L2 and L3 calcium imaging)
		raw_data>Tm1iGluSnFR
		raw_data>Tm9iGluSnFR

### Dm12 imaging (Figure 7)
Analysis for full field flashes and receptive field mapping with OFF stripes.


Dm12>Dm12_FFF.m (full field flashes)
	- plots and analysis for Dm12 full field flashes
		data: “processed_data/Dm12_Figure7_Mat_files/Dm12 imaging>processedTableWithoutBackgroundOnOff.mat”
Dm12>Dm12_stripes.m (receptive field mapping with OFF stripes)
	- plots and analysis for Dm12 receptive field mapping with OFF stripes
		data: processed_data/Dm12_Figure7_Mat_files/Dm12 imaging/processedTableWithoutBackgroundOnOff.mat

### Dm12 optogenetics (Figure 7)

Data and plots are found under processed_data/Dm12_Figure7_Mat_files//Dm12 optogenetics. Code for analysis can be found at: https://github.com/lgior/flylight/.


## FAFB EM dataset analysis (Figure 7)

### Code and data
Code is found under: EM analysis
	run “anatomical-RF-analysis-and-plot.ipynb” to analyze the data and generating the figures 
Data: processed_data//EM_data
Authorship files: processed_data//EM_data/EM_FlyWire_authorships
	